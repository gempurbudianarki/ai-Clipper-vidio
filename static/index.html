<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>AI Video Editor Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Inter', sans-serif; }

    /* ========= THEMES ========= */
    :root{
      --bg1:#020617;
      --bg2:#020617;
      --glass: rgba(255,255,255,0.08);
      --glass2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.10);
      --txt: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.58);
      --muted2: rgba(255,255,255,0.42);
      --accent:#22d3ee; /* cyan */
      --accent2:#a855f7; /* purple */
      --good:#34d399; /* emerald */
      --bad:#fb7185;  /* rose */
      --warn:#fbbf24; /* amber */
      --shadow: 0 0 22px rgba(34,211,238,.25), inset 0 0 18px rgba(34,211,238,.10);
      --shadow2: 0 0 22px rgba(168,85,247,.22), inset 0 0 18px rgba(168,85,247,.10);
      --radius: 22px;
    }

    body[data-theme="neon"]{
      background:
        radial-gradient(circle at 20% 20%, rgba(14,165,233,0.35) 0%, transparent 42%),
        radial-gradient(circle at 80% 80%, rgba(168,85,247,0.32) 0%, transparent 42%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--txt);
    }

    body[data-theme="dark"]{
      background:
        radial-gradient(circle at 30% 15%, rgba(99,102,241,0.22) 0%, transparent 46%),
        radial-gradient(circle at 70% 85%, rgba(34,211,238,0.18) 0%, transparent 52%),
        linear-gradient(180deg, #0b1020, #050712);
      color: var(--txt);
    }

    body[data-theme="minimal"]{
      background:
        linear-gradient(180deg, #0b1220, #0a0f1a);
      color: var(--txt);
    }

    .glass{
      background: var(--glass);
      backdrop-filter: blur(18px);
      border: 1px solid var(--stroke);
    }

    .glass-soft{
      background: var(--glass2);
      backdrop-filter: blur(18px);
      border: 1px solid var(--stroke2);
    }

    .neon{
      box-shadow: var(--shadow);
    }

    .neon2{
      box-shadow: var(--shadow2);
    }

    .btn{
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      transition: transform .12s ease, filter .2s ease, box-shadow .2s ease, opacity .2s ease;
      user-select: none;
    }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn:disabled{ opacity: .45; cursor: not-allowed; }

    .btn-cyan{
      background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(14,165,233,0.85));
      box-shadow: 0 10px 26px rgba(34,211,238,0.18);
    }
    .btn-cyan:hover{ filter: brightness(1.06); box-shadow: 0 12px 32px rgba(34,211,238,0.25); }

    .btn-purple{
      background: linear-gradient(135deg, rgba(168,85,247,0.95), rgba(99,102,241,0.85));
      box-shadow: 0 10px 26px rgba(168,85,247,0.18);
    }
    .btn-purple:hover{ filter: brightness(1.06); box-shadow: 0 12px 32px rgba(168,85,247,0.25); }

    .btn-emerald{
      background: linear-gradient(135deg, rgba(52,211,153,0.95), rgba(16,185,129,0.85));
      box-shadow: 0 10px 26px rgba(52,211,153,0.18);
    }
    .btn-emerald:hover{ filter: brightness(1.06); box-shadow: 0 12px 32px rgba(52,211,153,0.25); }

    .btn-ghost{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,0.09); }

    .tag{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }

    /* ========= LOADING ========= */
    .ring{
      width:56px;height:56px;border-radius:999px;
      border:6px solid rgba(255,255,255,.10);
      border-top-color: var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg) } }

    .pulsebar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .pulsebar > div{
      height:100%;
      width:40%;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: slide 1.1s infinite;
    }
    @keyframes slide { 0%{transform:translateX(-120%)} 100%{transform:translateX(320%)} }

    /* ========= PROGRESS ========= */
    .progressWrap{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,211,238,0.95), rgba(168,85,247,0.90));
      transition: width .25s ease;
    }
    .progressBar.error {
      background: var(--bad);
    }

    /* ========= TOAST ========= */
    #toastBox {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      background: rgba(10,12,24,0.9);
      backdrop-filter: blur(12px);
      border: 1px solid var(--stroke);
      color: var(--txt);
      padding: 12px 20px;
      border-radius: 99px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toast.error { border-color: var(--bad); color: var(--bad); }
    .toast.success { border-color: var(--good); color: var(--good); }
    @keyframes slideDown { from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeOut { from{opacity:1} to{opacity:0} }

    /* ========= MODAL ========= */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(1100px, 96vw);
      max-height: 92vh;
      overflow: hidden;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(10,12,24,0.82);
      backdrop-filter: blur(18px);
      box-shadow: 0 22px 80px rgba(0,0,0,0.55);
      display: flex;
      flex-direction: column;
    }
    .modalHeader{
      padding: 16px 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .modalBody{
      padding: 16px 18px;
      overflow: auto;
    }
    .modalFooter{
      padding: 14px 18px;
      border-top: 1px solid rgba(255,255,255,0.10);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }

    /* ========= TIMELINE TABLE ========= */
    .rowItem{
      display:grid;
      grid-template-columns: 110px 110px 1fr 130px;
      gap:10px;
      align-items:center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 10px;
      transition: transform .12s ease, background .2s ease;
    }
    .rowItem:hover{ background: rgba(255,255,255,0.07); transform: translateY(-1px); }

    .inp{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      outline: none;
      color: rgba(255,255,255,0.92);
    }
    .inp:focus{
      border-color: rgba(34,211,238,0.55);
      box-shadow: 0 0 0 4px rgba(34,211,238,0.15);
    }

    .tinyBtn{
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      transition: background .2s ease, transform .12s ease;
    }
    .tinyBtn:hover{ background: rgba(255,255,255,0.10); }
    .tinyBtn:active{ transform: translateY(1px); }

    .kbd{
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }

    /* little vibe */
    .floaty{
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0px); }
      50%{ transform: translateY(-6px); }
    }
  </style>
</head>

<body class="p-6" data-theme="neon">
  <div id="toastBox"></div>

  <div class="max-w-7xl mx-auto glass neon rounded-[var(--radius)] p-7 md:p-8">

    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5 mb-7">
      <div>
        <div class="text-xs" style="color:var(--muted2)">Creator Studio</div>
        <div class="flex items-center gap-3 mt-1">
          <div class="glass-soft neon2 rounded-2xl px-4 py-2 text-lg font-black floaty">‚ö°</div>
          <div>
            <h1 class="text-3xl md:text-4xl font-black tracking-tight">AI VIDEO EDITOR</h1>
            <p class="mt-1 text-sm" style="color:var(--muted)">
              Auto Clip ‚Ä¢ Multi-model (DeepSeek + Qwen) ‚Ä¢ Timeline Subtitle Editor
            </p>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          <span class="tag">Preset: TikTok/IG (9:16)</span>
          <span class="tag">Kinetic Subtitle (ASS)</span>
          <span class="tag">Auto Clip (AI)</span>
          <span class="tag">FFmpeg Render</span>
        </div>
      </div>

      <div class="flex flex-col gap-3 items-start md:items-end">
        <div class="glass rounded-2xl px-4 py-3 text-sm">
          Status: <span id="miniStatus" class="font-extrabold" style="color:var(--accent)">Ready</span>
        </div>

        <div class="flex items-center gap-2">
          <div class="text-xs" style="color:var(--muted2)">Theme</div>
          <select id="themeSelect" class="inp text-sm" style="width:170px">
            <option value="neon" selected>Neon</option>
            <option value="dark">Dark</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid lg:grid-cols-12 gap-6">

      <div class="lg:col-span-4 glass rounded-2xl p-6">
        <h2 class="font-extrabold text-lg mb-4">üé• Input</h2>

        <input id="videoInput" type="file" accept="video/*"
          class="block w-full mb-4 text-sm
          file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
          file:bg-cyan-600 file:text-white hover:file:bg-cyan-700" />

        <div class="grid grid-cols-2 gap-3">
          <button id="btnUpload" class="btn btn-cyan" onclick="uploadVideo()">Upload</button>
          <button id="btnTranscribe" class="btn btn-emerald" onclick="runTranscribe()" disabled>Transcribe</button>
        </div>

        <button id="btnClips" class="btn btn-purple w-full mt-3" onclick="runClips()" disabled>
          Generate Clips
        </button>

        <div class="mt-6 glass rounded-2xl p-4">
          <div class="flex items-center gap-4">
            <div id="loader" class="hidden">
              <div class="ring"></div>
            </div>

            <div class="flex-1">
              <div id="statusText" class="font-bold" style="color:var(--txt)">Menunggu input‚Ä¶</div>
              <div id="subStatus" class="text-sm mt-1" style="color:var(--muted)">
                Upload video untuk mulai.
              </div>

              <div class="mt-3 progressWrap">
                <div id="progressBar" class="progressBar"></div>
              </div>
              <div class="flex justify-between mt-1 text-xs" style="color:var(--muted2)">
                <span id="progressHint">Idle</span>
                <span><span id="progressPct">0</span>%</span>
              </div>

              <div class="pulsebar mt-3 hidden" id="pulse">
                <div></div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs" style="color:var(--muted2)">
          Hotkeys: <span class="kbd">U</span> Upload ‚Ä¢ <span class="kbd">T</span> Transcribe ‚Ä¢ <span class="kbd">G</span> Generate
        </div>

        <div class="mt-3 text-xs" style="color:var(--muted2)">
          Tips: clip default 25‚Äì60 detik biar nggak kepotong. Jangan refresh halaman pas rendering.
        </div>
      </div>

      <div class="lg:col-span-8 glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-extrabold text-lg">üß© Output Clips</h2>
          <div class="text-sm" style="color:var(--muted)">
            Klik <b>Timeline Editor</b> ‚Üí atur subtitle ‚Üí <b>Render Subtitle</b>
          </div>
        </div>

        <div id="clipsHint" style="color:var(--muted)">Belum ada clip. Generate dulu.</div>
        <div id="clipsBox" class="grid md:grid-cols-2 gap-4 mt-4"></div>
      </div>

    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modalHeader">
        <div class="flex flex-col">
          <div class="text-xs" style="color:var(--muted2)">Timeline Subtitle Editor</div>
          <div class="text-lg font-black" id="modalTitle">Clip</div>
          <div class="text-xs mt-1" style="color:var(--muted)">
            Edit start/end/text (detik). Ini timeline RELATIVE (mulai dari 0 di clip).
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button class="tinyBtn" id="btnAddRow">+ Add Row</button>
          <button class="tinyBtn" id="btnCloseModal">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="glass-soft rounded-2xl p-4 mb-4">
          <div class="grid md:grid-cols-3 gap-3 text-sm">
            <div>
              <div class="text-xs" style="color:var(--muted2)">Transcript</div>
              <div class="font-bold" id="modalTranscriptName">-</div>
            </div>
            <div>
              <div class="text-xs" style="color:var(--muted2)">Clip Original Range</div>
              <div class="font-bold"><span id="modalAbsStart">-</span>s ‚Üí <span id="modalAbsEnd">-</span>s</div>
            </div>
            <div>
              <div class="text-xs" style="color:var(--muted2)">Quick Tools</div>
              <div class="flex flex-wrap gap-2 mt-1">
                <button class="tinyBtn" id="btnNormalize">Normalize</button>
                <button class="tinyBtn" id="btnTighten">Tighten</button>
                <button class="tinyBtn" id="btnExpand">Expand</button>
              </div>
            </div>
          </div>
        </div>

        <div class="text-xs mb-2" style="color:var(--muted2)">
          Format: <span class="kbd">start</span> <span class="kbd">end</span> <span class="kbd">text</span>.  
          Tip: kalau subtitle telat ‚Üí kecilin start. Kalau kecepetan ‚Üí gedein start.
        </div>

        <div id="timelineBox"></div>
      </div>

      <div class="modalFooter">
        <div class="text-xs" style="color:var(--muted2)">
          Render akan burn subtitle ke video via FFmpeg.
        </div>

        <div class="flex gap-2">
          <button class="btn btn-ghost" id="btnPreviewApply">Save Draft</button>
          <button class="btn btn-purple" id="btnRenderSubtitle">Render Subtitle</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==============================
   GLOBAL STATE
============================== */
let uploadedFilename = null;
let latestClips = [];
let activeClip = null;  
let activeTimeline = [];
let isBusy = false;

const loader = document.getElementById("loader");
const pulse = document.getElementById("pulse");
const statusText = document.getElementById("statusText");
const subStatus = document.getElementById("subStatus");
const miniStatus = document.getElementById("miniStatus");

const progressBar = document.getElementById("progressBar");
const progressPct = document.getElementById("progressPct");
const progressHint = document.getElementById("progressHint");

const btnTranscribe = document.getElementById("btnTranscribe");
const btnClips = document.getElementById("btnClips");

/* ==============================
   THEME
============================== */
const themeSelect = document.getElementById("themeSelect");
themeSelect.addEventListener("change", () => {
  document.body.setAttribute("data-theme", themeSelect.value);
});

/* ==============================
   UTIL
============================== */
function esc(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function fmt(n){ return (Number(n)||0).toFixed(2); }

function setProgress(pct, hint="") {
  pct = clamp(Number(pct)||0, 0, 100);
  progressBar.style.width = pct + "%";
  progressPct.textContent = String(Math.round(pct));
  progressHint.textContent = hint || (pct===0 ? "Idle" : "Working‚Ä¶");
}

function setLoading(title, detail="", pct=10) {
  isBusy = true;
  loader.classList.remove("hidden");
  pulse.classList.remove("hidden");
  progressBar.classList.remove("error"); // reset error state
  
  statusText.textContent = title;
  subStatus.textContent = detail;
  statusText.style.color = "var(--txt)";
  
  miniStatus.textContent = "Processing‚Ä¶";
  miniStatus.style.color = "var(--warn)";
  
  setProgress(pct, title);
}

function setDone(title, detail="", pct=100, isError=false) {
  isBusy = false;
  loader.classList.add("hidden");
  pulse.classList.add("hidden");
  
  statusText.textContent = title;
  subStatus.textContent = detail;
  
  if (isError) {
    miniStatus.textContent = "Error";
    miniStatus.style.color = "var(--bad)";
    statusText.style.color = "var(--bad)";
    progressBar.classList.add("error");
  } else {
    miniStatus.textContent = "Ready";
    miniStatus.style.color = "var(--accent)";
    statusText.style.color = "var(--good)";
    progressBar.classList.remove("error");
  }
  
  setProgress(pct, title);
  if (!isError) {
    setTimeout(()=> setProgress(0,"Idle"), 1500);
  }
}

function showToast(msg, type='info') {
  const box = document.getElementById("toastBox");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  el.innerHTML = `
    <span>${type==='error'?'‚ùå':'‚ú®'}</span>
    <span>${esc(msg)}</span>
  `;
  box.appendChild(el);
  setTimeout(() => {
    el.style.animation = "fadeOut 0.3s forwards";
    setTimeout(() => el.remove(), 300);
  }, 4000);
}

/* ==============================
   HOTKEYS
============================== */
document.addEventListener("keydown", (e) => {
  if (e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
  if (e.key.toLowerCase()==="u") uploadVideo();
  if (e.key.toLowerCase()==="t") runTranscribe();
  if (e.key.toLowerCase()==="g") runClips();
});

/* ==============================
   API CALLS
============================== */
async function uploadVideo() {
  const input = document.getElementById("videoInput");
  if (!input.files.length) return showToast("Pilih video dulu bro üò≠", "error");

  setLoading("Uploading‚Ä¶", "Mengirim file ke server", 10);

  const fd = new FormData();
  fd.append("file", input.files[0]);

  try {
    const res = await fetch("/api/upload/video", { method:"POST", body: fd });
    const data = await res.json().catch(()=> ({}));

    if (!res.ok) {
      setDone("Upload gagal", data.detail || "Server error", 100, true);
      showToast(data.detail || "Upload gagal", "error");
      return;
    }

    uploadedFilename = data.filename;
    btnTranscribe.disabled = false;
    btnClips.disabled = true;

    setDone("Upload sukses ‚úî", "File siap. Lanjut Transcribe.", 100);
    showToast("Upload berhasil!");
  } catch(e) {
    setDone("Connection Error", e.message, 0, true);
    showToast("Gagal koneksi ke server", "error");
  }
}

async function runTranscribe() {
  if (!uploadedFilename) return showToast("Upload dulu bro üòÖ", "error");
  if (isBusy) return;

  setLoading("Transcribing‚Ä¶", "Whisper AI sedang mendengar (bisa agak lama)", 15);

  // Fake progress biar user ga panik
  let pct = 15;
  const t = setInterval(() => {
    if(!isBusy) clearInterval(t);
    pct = Math.min(pct + Math.random()*4, 90);
    setProgress(pct, "Transcribing‚Ä¶");
  }, 1000);

  try {
    const res = await fetch(`/api/transcribe/video/${encodeURIComponent(uploadedFilename)}`, { method:"POST" });
    const data = await res.json().catch(()=> ({}));
    clearInterval(t);

    if (!res.ok) {
      setDone("Transcribe gagal", data.detail || "Unknown error", 100, true);
      showToast(data.detail, "error");
      return;
    }

    btnClips.disabled = false;
    setDone("Transcribe selesai ‚úî", "Lanjut Generate Clips.", 100);
    showToast("Transcribe selesai!", "success");
  } catch(e) {
    clearInterval(t);
    setDone("Error", e.message, 0, true);
    showToast(e.message, "error");
  }
}

async function runClips() {
  if (!uploadedFilename) return showToast("Upload dulu bro üòÖ", "error");
  if (isBusy) return;

  setLoading("Generating clips‚Ä¶", "DeepSeek menganalisa, Qwen menulis hook, FFmpeg memotong.", 10);
  document.getElementById("clipsHint").textContent = "Sedang generate‚Ä¶";
  document.getElementById("clipsBox").innerHTML = "";

  let pct = 10;
  const t = setInterval(() => {
    if(!isBusy) clearInterval(t);
    pct = Math.min(pct + Math.random()*2, 95); // Slower fake progress
    setProgress(pct, "Analyzing & Rendering‚Ä¶");
  }, 1200);

  try {
    // Timeout di backend 120s, jadi fetch kita tungguin aja
    const res = await fetch(`/api/clips/generate/${encodeURIComponent(uploadedFilename)}?max_clips=6&min_sec=25&max_sec=60`, { method:"POST" });
    const data = await res.json().catch(()=> ({}));
    clearInterval(t);

    if (!res.ok) {
      setDone("Generate gagal", data.detail || "AI Error", 100, true);
      document.getElementById("clipsHint").textContent = "Gagal generate clips. Cek error di atas.";
      showToast(data.detail || "Generate gagal", "error");
      return;
    }

    const clips = data.clips || [];
    latestClips = clips;

    if (!clips.length) {
      setDone("Tidak ada clip", "AI tidak menemukan momen yang pas.", 100, true);
      document.getElementById("clipsHint").textContent = "Tidak ada clip.";
      return;
    }

    renderClips(clips);
    setDone("Clips siap ‚úî", `Total: ${clips.length} clips.`, 100);
    showToast("Clips berhasil dibuat!", "success");
  } catch(e) {
    clearInterval(t);
    setDone("Network Error", e.message, 0, true);
    showToast("Gagal koneksi atau timeout", "error");
  }
}

/* ==============================
   RENDER CLIPS UI
============================== */
function renderClips(clips) {
  const box = document.getElementById("clipsBox");
  const hint = document.getElementById("clipsHint");
  hint.textContent = `Found ${clips.length} clips`;
  box.innerHTML = "";

  clips.forEach((c, idx) => {
    const card = document.createElement("div");
    card.className = "glass rounded-2xl p-4 border border-white/10";

    const score = (c.score ?? 0);
    const hook = c.hook || "";
    const reason = c.reason || "";
    const startAbs = Number(c.start ?? 0);
    const endAbs = Number(c.end ?? 0);
    // Add timestamp to force reload cache
    const videoUrl = `${c.url}?t=${Date.now()}`;

    card.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-black text-cyan-400">Clip #${idx+1}</div>
        <div class="text-xs" style="color:var(--muted)">score ${Number(score).toFixed(2)}</div>
      </div>

      <div class="text-sm mb-2">
        <div class="text-xs" style="color:var(--muted2)">Hook</div>
        <div class="font-bold text-white">${esc(hook)}</div>
      </div>

      <div class="text-xs mb-3 italic" style="color:var(--muted)">"${esc(reason)}"</div>

      <div class="relative bg-black rounded-xl overflow-hidden aspect-[9/16] mb-3">
        <video controls class="w-full h-full object-contain" src="${videoUrl}" preload="metadata"></video>
      </div>

      <div class="grid grid-cols-2 gap-2 text-xs mb-3" style="color:var(--muted)">
        <div>Start: <span style="color:var(--txt)">${fmt(startAbs)}s</span></div>
        <div>End: <span style="color:var(--txt)">${fmt(endAbs)}s</span></div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-auto">
        <button class="btn btn-cyan w-full text-xs" data-timeline>Timeline Editor</button>
        <a class="btn btn-ghost w-full text-center text-xs flex items-center justify-center" href="${c.url}" target="_blank">Download</a>
      </div>
    `;

    const btnTimeline = card.querySelector("[data-timeline]");
    const vid = card.querySelector("video");

    btnTimeline.addEventListener("click", async () => {
      activeClip = { ...c, _idx: idx, _videoEl: vid };
      await openTimelineEditor(activeClip);
    });

    box.appendChild(card);
  });
}

/* ==============================
   MODAL LOGIC
============================== */
const modalBackdrop = document.getElementById("modalBackdrop");
const btnCloseModal = document.getElementById("btnCloseModal");
const btnAddRow = document.getElementById("btnAddRow");
const btnRenderSubtitle = document.getElementById("btnRenderSubtitle");
const btnPreviewApply = document.getElementById("btnPreviewApply");
const btnNormalize = document.getElementById("btnNormalize");
const btnTighten = document.getElementById("btnTighten");
const btnExpand = document.getElementById("btnExpand");

btnCloseModal.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

function openModal(){ modalBackdrop.style.display = "flex"; }
function closeModal(){
  modalBackdrop.style.display = "none";
  activeTimeline = [];
  activeClip = null;
}

function getModalEls(){
  return {
    title: document.getElementById("modalTitle"),
    transcript: document.getElementById("modalTranscriptName"),
    absStart: document.getElementById("modalAbsStart"),
    absEnd: document.getElementById("modalAbsEnd"),
    box: document.getElementById("timelineBox"),
  };
}

async function openTimelineEditor(clip) {
  if (!uploadedFilename) return showToast("Transcript belum ada", "error");

  const els = getModalEls();
  els.title.textContent = `Editing Clip #${clip._idx + 1}`;
  els.transcript.textContent = uploadedFilename;
  els.absStart.textContent = fmt(clip.start);
  els.absEnd.textContent = fmt(clip.end);

  openModal();
  els.box.innerHTML = `<div class="text-sm p-4 text-center" style="color:var(--muted)">Loading timeline data‚Ä¶</div>`;

  try {
    const url = `/api/subtitle/timeline/${encodeURIComponent(clip.file)}?transcript_name=${encodeURIComponent(uploadedFilename)}&clip_start_abs=${encodeURIComponent(clip.start)}&clip_end_abs=${encodeURIComponent(clip.end)}`;
    const res = await fetch(url, { method:"POST" });
    const data = await res.json().catch(()=> ({}));

    if (!res.ok) {
      els.box.innerHTML = `<div class="text-sm text-red-400 p-4">Error: ${esc(data.detail)}</div>`;
      return;
    }

    activeTimeline = (data.items || []).map(x => ({
      start: Number(x.start ?? 0),
      end: Number(x.end ?? 0.8),
      text: String(x.text ?? "")
    }));

    renderTimelineRows();
  } catch(err) {
    els.box.innerHTML = `<div class="text-sm text-red-400 p-4">Network Error: ${esc(String(err))}</div>`;
  }
}

function renderTimelineRows() {
  const els = getModalEls();
  const box = els.box;

  if (!activeTimeline.length) {
    box.innerHTML = `<div class="text-sm text-center p-6" style="color:var(--muted)">Timeline kosong. Klik "+ Add Row" untuk mulai manual.</div>`;
    return;
  }

  box.innerHTML = "";

  activeTimeline.forEach((it, i) => {
    const row = document.createElement("div");
    row.className = "rowItem";

    row.innerHTML = `
      <div>
        <div class="text-[10px]" style="color:var(--muted2)">Start (s)</div>
        <input class="inp text-xs" type="number" step="0.1" value="${fmt(it.start)}" data-start />
      </div>
      <div>
        <div class="text-[10px]" style="color:var(--muted2)">End (s)</div>
        <input class="inp text-xs" type="number" step="0.1" value="${fmt(it.end)}" data-end />
      </div>
      <div>
        <div class="text-[10px]" style="color:var(--muted2)">Subtitle Text</div>
        <input class="inp text-sm font-semibold" type="text" value="${esc(it.text)}" data-text />
      </div>
      <div class="flex gap-1 justify-end">
        <button class="tinyBtn px-2" data-up title="Move up">‚Üë</button>
        <button class="tinyBtn px-2" data-down title="Move down">‚Üì</button>
        <button class="tinyBtn px-2 text-rose-400 border-rose-400/30 hover:bg-rose-500/10" data-del title="Delete">√ó</button>
      </div>
    `;

    const startEl = row.querySelector("[data-start]");
    const endEl = row.querySelector("[data-end]");
    const textEl = row.querySelector("[data-text]");

    startEl.addEventListener("change", () => activeTimeline[i].start = Number(startEl.value||0));
    endEl.addEventListener("change", () => activeTimeline[i].end = Number(endEl.value||0));
    textEl.addEventListener("change", () => activeTimeline[i].text = textEl.value || "");

    row.querySelector("[data-del]").addEventListener("click", () => {
      activeTimeline.splice(i,1);
      renderTimelineRows();
    });

    row.querySelector("[data-up]").addEventListener("click", () => {
      if (i===0) return;
      [activeTimeline[i-1], activeTimeline[i]] = [activeTimeline[i], activeTimeline[i-1]];
      renderTimelineRows();
    });

    row.querySelector("[data-down]").addEventListener("click", () => {
      if (i===activeTimeline.length-1) return;
      [activeTimeline[i+1], activeTimeline[i]] = [activeTimeline[i], activeTimeline[i+1]];
      renderTimelineRows();
    });

    box.appendChild(row);
  });
}

/* ==============================
   TIMELINE TOOLS
============================== */
btnAddRow.addEventListener("click", () => {
  const lastEnd = activeTimeline.length > 0 ? activeTimeline[activeTimeline.length-1].end + 0.1 : 0;
  activeTimeline.push({ start: lastEnd, end: lastEnd + 1.0, text: "New Subtitle" });
  renderTimelineRows();
  // scroll to bottom
  const box = getModalEls().box;
  setTimeout(() => box.scrollTop = box.scrollHeight, 50);
});

btnNormalize.addEventListener("click", () => {
  activeTimeline.sort((a,b) => a.start - b.start);
  renderTimelineRows();
  showToast("Timeline sorted");
});

btnTighten.addEventListener("click", () => {
  activeTimeline = activeTimeline.map(x => ({
    ...x,
    start: Number((x.start + 0.05).toFixed(2)),
    end: Number((x.end - 0.05).toFixed(2))
  }));
  renderTimelineRows();
});

btnExpand.addEventListener("click", () => {
  activeTimeline = activeTimeline.map(x => ({
    ...x,
    start: Number((Math.max(0, x.start - 0.05)).toFixed(2)),
    end: Number((x.end + 0.05).toFixed(2))
  }));
  renderTimelineRows();
});

btnPreviewApply.addEventListener("click", () => {
  showToast("Draft saved locally (belum di-render).", "info");
});

/* ==============================
   RENDER SUBTITLE (BACKEND)
============================== */
btnRenderSubtitle.addEventListener("click", async () => {
  if (!activeClip) return;
  if (isBusy) return;

  btnNormalize.click(); // auto sort before render
  const confirmMsg = "Render subtitle akan 'membakar' text ke video (permanen). Lanjut?";
  if(!confirm(confirmMsg)) return;

  setLoading("Rendering Subtitle‚Ä¶", "FFmpeg burning ASS subtitle (Hardsub)", 20);

  // Fake progress for rendering
  let pct = 20;
  const t = setInterval(() => {
    if(!isBusy) clearInterval(t);
    pct = Math.min(pct + Math.random()*5, 95);
    setProgress(pct, "Burning Subtitle‚Ä¶");
  }, 800);

  try {
    const payload = {
      transcript_name: uploadedFilename,
      clip_start_abs: Number(activeClip.start||0),
      clip_end_abs: Number(activeClip.end||0),
      items: activeTimeline
    };

    const res = await fetch(`/api/subtitle/render/${encodeURIComponent(activeClip.file)}`, {
      method:"POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=> ({}));
    clearInterval(t);

    if (!res.ok) {
      setDone("Render Gagal", data.detail || "Unknown error", 100, true);
      showToast("Gagal render subtitle", "error");
      return;
    }

    if (activeClip._videoEl && data.url) {
      // Force browser to reload video with timestamp query
      const newUrl = data.url + "?t=" + Date.now();
      activeClip._videoEl.src = newUrl;
      activeClip._videoEl.load(); 
    }

    setDone("Subtitle Selesai ‚úî", "Video player telah di-refresh.", 100);
    showToast("Subtitle berhasil di-burn!", "success");
    closeModal();
  } catch(e) {
    clearInterval(t);
    setDone("Connection Error", e.message, 0, true);
    showToast(e.message, "error");
  }
});
</script>
</body>
</html>