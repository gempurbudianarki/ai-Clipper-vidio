<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>AI Video Editor Studio ‚Äî Ultimate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Inter', sans-serif; }

    /* ========= THEMES ========= */
    :root{
      --bg1:#020617; --bg2:#0f172a;
      --glass: rgba(255,255,255,0.08); --glass2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12); --stroke2: rgba(255,255,255,0.10);
      --txt: rgba(255,255,255,0.92); --muted: rgba(255,255,255,0.58);
      --accent:#22d3ee; --accent2:#a855f7; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --shadow: 0 0 22px rgba(34,211,238,.25), inset 0 0 18px rgba(34,211,238,.10);
      --radius: 22px;
    }
    body[data-theme="neon"]{ background: radial-gradient(circle at 20% 20%, rgba(14,165,233,0.35) 0%, transparent 42%), radial-gradient(circle at 80% 80%, rgba(168,85,247,0.32) 0%, transparent 42%), linear-gradient(180deg, var(--bg1), var(--bg2)); color: var(--txt); }
    body[data-theme="dark"]{ background: radial-gradient(circle at 30% 15%, rgba(99,102,241,0.22) 0%, transparent 46%), radial-gradient(circle at 70% 85%, rgba(34,211,238,0.18) 0%, transparent 52%), linear-gradient(180deg, #0b1020, #050712); color: var(--txt); }
    body[data-theme="minimal"]{ background: linear-gradient(180deg, #0b1220, #0a0f1a); color: var(--txt); }

    /* UTILS */
    .glass{ background: var(--glass); backdrop-filter: blur(18px); border: 1px solid var(--stroke); }
    .glass-soft{ background: var(--glass2); backdrop-filter: blur(18px); border: 1px solid var(--stroke2); }
    .neon{ box-shadow: var(--shadow); }

    /* BUTTONS */
    .btn{ border-radius: 14px; padding: 12px 14px; font-weight: 800; transition: transform .12s ease, filter .2s ease; user-select: none; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn:disabled{ opacity: .45; cursor: not-allowed; filter: grayscale(1); }
    .btn-cyan{ background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(14,165,233,0.85)); color: #000; }
    .btn-cyan:hover{ filter: brightness(1.06); }
    .btn-purple{ background: linear-gradient(135deg, rgba(168,85,247,0.95), rgba(99,102,241,0.85)); color: #fff; }
    .btn-emerald{ background: linear-gradient(135deg, rgba(52,211,153,0.95), rgba(16,185,129,0.85)); color: #000; }
    .btn-ghost{ background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: var(--txt); }
    
    .tag{ border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); padding: 6px 12px; border-radius: 999px; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); }
    
    /* ANIMATIONS */
    .ring{ width:56px;height:56px;border-radius:999px; border:6px solid rgba(255,255,255,.10); border-top-color: var(--accent); animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg) } }
    .pulsebar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden; margin-top: 10px;}
    .pulsebar > div{ height:100%; width:40%; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: slide 1.1s infinite; }
    @keyframes slide { 0%{transform:translateX(-120%)} 100%{transform:translateX(320%)} }
    
    .progressBar{ height:100%; width:0%; background: linear-gradient(90deg, rgba(34,211,238,0.95), rgba(168,85,247,0.90)); transition: width .3s cubic-bezier(0.4, 0, 0.2, 1); }
    .progressBar.error { background: var(--bad); }

    /* TOAST */
    #toastBox { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { pointer-events: auto; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border: 1px solid var(--stroke); color: var(--txt); padding: 12px 24px; border-radius: 99px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px; animation: slideDown 0.35s; }
    .toast.error { border-color: var(--bad); color: var(--bad); }
    .toast.success { border-color: var(--good); color: var(--good); }
    @keyframes slideDown { from{opacity:0; transform:translateY(-30px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeOut { from{opacity:1} to{opacity:0} }

    /* TABS */
    .tab-btn { padding: 10px; border-radius: 12px; font-size: 13px; font-weight: 700; color: var(--muted); cursor: pointer; transition: all 0.2s; border: 1px solid transparent; flex: 1; text-align: center; }
    .tab-btn.active { background: rgba(255,255,255,0.1); color: var(--txt); border-color: rgba(255,255,255,0.1); }
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

    /* MODAL */
    .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
    .modal{ width: min(1100px, 98vw); max-height: 92vh; display: flex; flex-direction: column; border-radius: 24px; border: 1px solid rgba(255,255,255,0.14); background: #0f172a; box-shadow: 0 25px 100px rgba(0,0,0,0.8); }
    .modalHeader{ padding: 20px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); }
    .modalBody{ padding: 20px 24px; overflow-y: auto; flex: 1; }
    .modalFooter{ padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap: wrap; }

    /* INPUTS */
    .inp{ width: 100%; padding: 10px 14px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.12); outline: none; color: var(--txt); font-size: 13px; transition: all .2s; }
    .inp:focus{ border-color: var(--accent); background: rgba(0,0,0,0.5); }
    .rowItem{ display:grid; grid-template-columns: 90px 90px 1fr 100px; gap:12px; align-items:center; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); margin-bottom: 8px; }
    .tinyBtn{ padding: 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--muted); cursor: pointer; transition: all .2s; }
    .tinyBtn:hover{ background: rgba(255,255,255,0.1); color: #fff; }
    .kbd{ padding: 3px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); font-family: monospace; font-size: 11px; }
  </style>
</head>

<body class="p-4 md:p-8" data-theme="neon">

  <div id="toastBox"></div>

  <div class="max-w-[1400px] mx-auto glass neon rounded-[var(--radius)] p-6 md:p-10 min-h-[90vh] flex flex-col">

    <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6 mb-10 border-b border-white/5 pb-6">
      <div class="flex items-center gap-5">
        <div class="glass-soft text-3xl p-4 rounded-2xl">‚ö°</div>
        <div>
          <div class="flex items-center gap-3">
            <h1 class="text-3xl md:text-5xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
              AI VIDEO STUDIO
            </h1>
            <span class="bg-white/10 text-[10px] px-2 py-1 rounded-md uppercase font-bold border border-white/10">Ultimate</span>
          </div>
          <p class="mt-2 text-sm text-white/60 font-medium">
            YouTube DL ‚Ä¢ DeepSeek AI ‚Ä¢ Vizard Karaoke ‚Ä¢ Custom BGM ‚Ä¢ Auto-Hook
          </p>
        </div>
      </div>

      <div class="flex flex-col items-end gap-3">
        <div class="glass rounded-xl px-5 py-2 flex items-center gap-3 text-sm font-semibold">
          <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
          Status: <span id="miniStatus" class="text-emerald-400">Ready</span>
        </div>
        
        <div class="flex items-center gap-2">
           <label class="text-xs font-semibold uppercase tracking-wider text-white/40">Theme</label>
           <select id="themeSelect" class="bg-black/30 border border-white/10 rounded-lg text-xs p-2 text-white/80 outline-none hover:border-cyan-500/50 cursor-pointer">
             <option value="neon">Neon Cyber</option>
             <option value="dark">Deep Space</option>
             <option value="minimal">Minimalist</option>
           </select>
        </div>
      </div>
    </div>

    <div class="grid lg:grid-cols-12 gap-8 flex-1">

      <div class="lg:col-span-4 flex flex-col gap-6">
        
        <div class="glass rounded-2xl p-6 relative overflow-hidden">
          <h2 class="font-bold text-xl mb-4">1. Input Source</h2>
          
          <div class="flex gap-2 mb-4 bg-black/20 p-1 rounded-xl">
            <div class="tab-btn active" onclick="switchTab('local')">üìÅ Upload File</div>
            <div class="tab-btn" onclick="switchTab('url')">üîó Paste URL</div>
          </div>

          <div id="tabLocal" class="tab-content active">
            <input id="videoInput" type="file" accept="video/*" class="w-full text-sm text-slate-500
              file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0
              file:text-sm file:font-bold file:bg-cyan-500/10 file:text-cyan-400
              hover:file:bg-cyan-500/20 cursor-pointer mb-4 border border-white/10 rounded-xl p-2 bg-black/20"
            />
            <button id="btnUpload" class="btn btn-cyan w-full" onclick="uploadVideo()">
              <span>‚òÅÔ∏è Upload Video</span>
            </button>
          </div>

          <div id="tabUrl" class="tab-content">
            <input id="urlInput" type="text" placeholder="https://youtube.com/shorts/..." class="inp mb-4 text-center" />
            <button id="btnUrlProcess" class="btn btn-cyan w-full" onclick="processUrl()">
              <span>üì• Download & Process</span>
            </button>
            <p class="text-[10px] mt-2 text-white/30 text-center">*Supports YouTube, TikTok, IG Reels</p>
          </div>

          <div class="mt-4 pt-4 border-t border-white/10">
             <button id="btnTranscribe" class="btn btn-emerald w-full" onclick="runTranscribe()" disabled>
                <span>üéôÔ∏è Start Transcribe</span>
             </button>
          </div>
        </div>

        <div class="glass rounded-2xl p-6 relative overflow-hidden">
           <h2 class="font-bold text-xl mb-3">2. AI Studio</h2>
           
           <details class="mb-4">
             <summary class="text-xs text-white/50 cursor-pointer hover:text-white mb-2 list-none flex items-center gap-1">
               <span>‚öôÔ∏è Advanced Settings</span> <span class="text-[10px]">‚ñº</span>
             </summary>
             <div class="bg-black/20 p-3 rounded-lg space-y-3">
               <div>
                 <label class="text-[10px] text-white/40 block mb-1">Max Clips</label>
                 <input type="range" min="1" max="10" value="6" class="w-full accent-purple-500" oninput="document.getElementById('valClips').innerText=this.value">
                 <div class="text-right text-[10px]"><span id="valClips">6</span> clips</div>
               </div>
               <div class="flex gap-2">
                 <div class="flex-1">
                   <label class="text-[10px] text-white/40 block mb-1">Min Sec</label>
                   <input type="number" id="minSec" value="25" class="inp text-xs p-1">
                 </div>
                 <div class="flex-1">
                   <label class="text-[10px] text-white/40 block mb-1">Max Sec</label>
                   <input type="number" id="maxSec" value="60" class="inp text-xs p-1">
                 </div>
               </div>
               <div>
                 <label class="text-[10px] text-white/40 block mb-1">Custom BGM (Optional)</label>
                 <div class="flex gap-2">
                    <input type="file" id="bgmInput" accept="audio/*" class="text-[10px] text-slate-500 file:py-1 file:px-2 file:rounded-lg file:border-0 file:bg-white/10 file:text-white w-full">
                    <button class="tinyBtn bg-purple-500/20 text-purple-300" onclick="uploadBgm()">Up</button>
                 </div>
                 <div id="bgmStatus" class="text-[9px] text-emerald-400 mt-1 hidden">‚úì BGM Uploaded</div>
               </div>
             </div>
           </details>

           <button id="btnClips" class="btn btn-purple w-full py-4 text-lg shadow-lg shadow-purple-900/20" onclick="runClips()" disabled>
             <span>‚ú® Generate Magic Clips</span>
           </button>
        </div>

        <div class="glass-soft rounded-2xl p-5 mt-auto">
           <div class="flex items-center gap-4">
             <div id="loader" class="hidden"><div class="ring"></div></div>
             <div class="flex-1 min-w-0">
               <div class="flex justify-between items-end mb-2">
                 <div id="statusText" class="font-bold truncate">Idle</div>
                 <div class="text-xs font-mono opacity-50"><span id="progressPct">0</span>%</div>
               </div>
               <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                 <div id="progressBar" class="progressBar"></div>
               </div>
               <div id="subStatus" class="text-xs mt-2 text-white/40 truncate">Waiting for input...</div>
             </div>
           </div>
        </div>
        
        <div class="text-center text-[10px] text-white/20 font-mono">
          Hotkeys: <span class="kbd">U</span> Upload ‚Ä¢ <span class="kbd">T</span> Transcribe ‚Ä¢ <span class="kbd">G</span> Generate
        </div>

      </div>

      <div class="lg:col-span-8 glass rounded-2xl p-6 md:p-8 flex flex-col min-h-[500px]">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="font-bold text-2xl">Output Clips</h2>
            <p class="text-sm text-white/50">Review, Edit Hook & Subtitles, Render Final.</p>
          </div>
          <div class="text-right hidden md:block">
            <div class="text-xs text-white/30 uppercase tracking-widest font-bold">Session ID</div>
            <div class="font-mono text-cyan-400" id="sessionId">---</div>
          </div>
        </div>

        <div id="clipsHint" class="flex-1 flex flex-col items-center justify-center text-white/20 gap-4 border-2 border-dashed border-white/5 rounded-2xl p-10">
          <div class="text-5xl">üé¨</div>
          <p>No clips generated yet.</p>
        </div>
        
        <div id="clipsBox" class="grid md:grid-cols-2 gap-5 pb-10"></div>
      </div>

    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h3 class="text-xl font-black text-white tracking-tight flex items-center gap-2">
             <span class="text-cyan-400">#</span> <span id="modalTitle">Clip Editor</span>
          </h3>
          <p class="text-xs text-white/50 mt-1">Timeline is relative (0s = start of clip).</p>
        </div>
        <div class="flex items-center gap-3">
          <button class="tinyBtn px-3 py-2 bg-white/5 border-white/10 hover:bg-white/10 text-white font-bold rounded-lg" id="btnAddRow">+ Add Line</button>
          <button class="p-2 hover:bg-white/10 rounded-full transition-colors text-white/50 hover:text-white" id="btnCloseModal">‚úï</button>
        </div>
      </div>

      <div class="modalBody bg-black/20">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
           <div class="bg-white/5 rounded-xl p-3 border border-white/5">
             <div class="text-[10px] uppercase text-white/40 font-bold">Original Range</div>
             <div class="font-mono text-sm text-cyan-400"><span id="modalAbsStart">00.00</span>s ‚ûî <span id="modalAbsEnd">00.00</span>s</div>
           </div>
           <div class="bg-white/5 rounded-xl p-3 border border-white/5 col-span-2 flex items-center gap-2">
             <button id="btnNormalize" class="flex-1 tinyBtn text-xs text-center">Sort</button>
             <button id="btnTighten" class="flex-1 tinyBtn text-xs text-center">Tighten</button>
             <button id="btnExpand" class="flex-1 tinyBtn text-xs text-center">Expand</button>
           </div>
        </div>

        <div class="grid grid-cols-[90px_90px_1fr_100px] gap-4 px-4 pb-2 text-[10px] uppercase font-bold text-white/30 tracking-wider">
          <div>Start</div><div>End</div><div>Subtitle Text</div><div class="text-right">Actions</div>
        </div>

        <div id="timelineBox" class="min-h-[200px]"></div>
      </div>

      <div class="modalFooter">
        <div class="flex flex-col gap-4 w-full md:w-auto flex-1">
           <div class="flex flex-wrap items-center gap-3 bg-black/40 p-2 pr-4 rounded-xl border border-white/10">
             <div class="flex items-center gap-2">
                 <div class="bg-white/5 px-2 py-1 rounded-md text-[10px] font-bold text-white/50 uppercase">Ratio</div>
                 <select id="ratioSelect" class="bg-transparent text-sm font-bold text-cyan-400 outline-none cursor-pointer">
                   <option value="9:16">üì± 9:16 (TikTok)</option>
                   <option value="1:1">üü¶ 1:1 (Feed)</option>
                   <option value="16:9">üì∫ 16:9 (YT)</option>
                 </select>
             </div>
             <div class="w-px h-6 bg-white/10"></div>
             <div class="flex items-center gap-2">
                 <div class="bg-white/5 px-2 py-1 rounded-md text-[10px] font-bold text-white/50 uppercase">Style</div>
                 <select id="styleSelect" class="bg-transparent text-sm font-bold text-purple-400 outline-none cursor-pointer">
                   <option value="hormozi">üî• Hormozi</option>
                   <option value="neon">‚ö° Neon</option>
                   <option value="box">‚¨õ Boxed</option>
                   <option value="classic">üìù Classic</option>
                 </select>
             </div>
           </div>
           
           <div class="flex items-center gap-2 w-full">
              <div class="bg-white/5 px-2 py-2 rounded-md text-[10px] font-bold text-white/50 uppercase whitespace-nowrap">Hook Banner</div>
              <input type="text" id="hookTextInput" class="inp py-2 text-sm font-bold text-white bg-black/40 border-white/10" placeholder="EDIT JUDUL BANNER DI SINI...">
           </div>
        </div>

        <div class="flex gap-3 mt-4 md:mt-0 w-full md:w-auto ml-auto">
          <button class="btn btn-ghost flex-1 md:flex-none" id="btnPreviewApply">Save Draft</button>
          <button class="btn btn-purple flex-1 md:flex-none px-8 shadow-lg shadow-purple-500/20" id="btnRenderSubtitle">
            üöÄ RENDER FINAL
          </button>
        </div>
      </div>

    </div>
  </div>

<script>
/* GLOBAL STATE */
let uploadedFilename = null;
let customBgmFile = null;
let latestClips = [];
let activeClip = null;  
let activeTimeline = [];
let isBusy = false;

/* DOM ELEMENTS */
const els = {
  loader: document.getElementById("loader"),
  statusText: document.getElementById("statusText"),
  subStatus: document.getElementById("subStatus"),
  miniStatus: document.getElementById("miniStatus"),
  progressBar: document.getElementById("progressBar"),
  progressPct: document.getElementById("progressPct"),
  btnTranscribe: document.getElementById("btnTranscribe"),
  btnClips: document.getElementById("btnClips"),
  clipsBox: document.getElementById("clipsBox"),
  clipsHint: document.getElementById("clipsHint"),
  sessionId: document.getElementById("sessionId"),
  modal: {
    backdrop: document.getElementById("modalBackdrop"),
    title: document.getElementById("modalTitle"),
    start: document.getElementById("modalAbsStart"),
    end: document.getElementById("modalAbsEnd"),
    box: document.getElementById("timelineBox"),
    ratio: document.getElementById("ratioSelect"),
    style: document.getElementById("styleSelect"),
    hook: document.getElementById("hookTextInput")
  }
};

els.sessionId.textContent = "SESS-" + Math.floor(Math.random()*10000);

/* UI HELPERS */
function showToast(msg, type='info') {
  const box = document.getElementById("toastBox");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  const icon = type === 'error' ? '‚ùå' : (type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è');
  el.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
  box.appendChild(el);
  setTimeout(() => { el.style.animation = "fadeOut 0.4s forwards"; setTimeout(() => el.remove(), 400); }, 4000);
}

function setProgress(pct, hint="") {
  pct = Math.max(0, Math.min(100, Number(pct)||0));
  els.progressBar.style.width = pct + "%";
  els.progressPct.textContent = Math.round(pct);
  if(hint) els.subStatus.textContent = hint;
}

function setLoading(title, subtitle="", startPct=5) {
  isBusy = true;
  els.loader.classList.remove("hidden");
  els.progressBar.classList.remove("error");
  els.statusText.textContent = title;
  els.miniStatus.textContent = "Processing...";
  els.miniStatus.className = "text-amber-400 animate-pulse";
  setProgress(startPct, subtitle);
}

function setDone(title, subtitle="", pct=100, isError=false) {
  isBusy = false;
  els.loader.classList.add("hidden");
  els.statusText.textContent = title;
  if (isError) {
    els.statusText.style.color = "var(--bad)";
    els.miniStatus.textContent = "Error";
    els.miniStatus.className = "text-rose-500 font-bold";
    els.progressBar.classList.add("error");
    setProgress(100, subtitle);
  } else {
    els.statusText.style.color = "var(--good)";
    els.miniStatus.textContent = "Ready";
    els.miniStatus.className = "text-emerald-400 font-bold";
    els.progressBar.classList.remove("error");
    setProgress(pct, subtitle);
    setTimeout(() => { if(!isBusy) setProgress(0, "Idle"); }, 2000);
  }
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  if(tab === 'local') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('tabLocal').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('tabUrl').classList.add('active');
  }
}

/* API ACTIONS */
async function uploadVideo() {
  const input = document.getElementById("videoInput");
  if (!input.files.length) return showToast("Select video file first.", "error");
  setLoading("Uploading...", "Sending file to server", 10);
  const fd = new FormData();
  fd.append("file", input.files[0]);
  try {
    const res = await fetch("/api/upload/video", { method:"POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail);
    uploadedFilename = data.filename;
    els.btnTranscribe.disabled = false;
    els.btnClips.disabled = true;
    setDone("Upload Success", "Ready to transcribe.", 100);
    showToast("Uploaded successfully!", "success");
  } catch(e) { setDone("Upload Failed", e.message, 0, true); showToast(e.message, "error"); }
}

async function processUrl() {
  const url = document.getElementById("urlInput").value;
  if(!url) return showToast("Paste a URL first!", "error");
  setLoading("Downloading...", "Fetching video via yt-dlp", 15);
  try {
    const res = await fetch("/api/upload/url", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({url: url})
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail);
    uploadedFilename = data.filename;
    els.btnTranscribe.disabled = false;
    els.btnClips.disabled = true;
    setDone("Download Success", "Video ready.", 100);
    showToast("Downloaded successfully!", "success");
  } catch(e) { setDone("Download Failed", e.message, 0, true); showToast(e.message, "error"); }
}

async function uploadBgm() {
  const input = document.getElementById("bgmInput");
  if (!input.files.length) return showToast("Select MP3 file first.", "error");
  const fd = new FormData();
  fd.append("file", input.files[0]);
  try {
    const res = await fetch("/api/upload/bgm", { method:"POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail);
    customBgmFile = data.filename;
    document.getElementById("bgmStatus").classList.remove("hidden");
    showToast("Custom BGM Uploaded!", "success");
  } catch(e) { showToast(e.message, "error"); }
}

async function runTranscribe() {
  if (!uploadedFilename) return showToast("No video uploaded.", "error");
  if (isBusy) return;
  setLoading("Transcribing...", "Whisper AI Word-Level Analysis...", 10);
  let p = 10; const t = setInterval(() => { if(!isBusy) clearInterval(t); p=Math.min(90, p+2); setProgress(p); }, 800);
  try {
    const res = await fetch(`/api/transcribe/video/${encodeURIComponent(uploadedFilename)}`, { method:"POST" });
    const data = await res.json();
    clearInterval(t);
    if (!res.ok) throw new Error(data.detail);
    els.btnClips.disabled = false;
    setDone("Transcribed", "Analysis complete.", 100);
    showToast("Transcription complete!", "success");
  } catch(e) { clearInterval(t); setDone("Error", e.message, 0, true); showToast(e.message, "error"); }
}

async function runClips() {
  if (!uploadedFilename) return;
  if (isBusy) return;
  
  const minSec = document.getElementById("minSec").value || 25;
  const maxSec = document.getElementById("maxSec").value || 60;
  const maxClips = document.getElementById("valClips").innerText || 6;

  setLoading("Generating Clips...", "DeepSeek reasoning...", 15);
  els.clipsHint.innerHTML = `<div class="ring"></div><p>AI is thinking...</p>`;
  els.clipsBox.innerHTML = "";
  
  let p = 15; const t = setInterval(() => { if(!isBusy) clearInterval(t); p=Math.min(95, p+1); setProgress(p); }, 1000);
  
  try {
    const res = await fetch(`/api/clips/generate/${encodeURIComponent(uploadedFilename)}?max_clips=${maxClips}&min_sec=${minSec}&max_sec=${maxSec}`, { method:"POST" });
    const data = await res.json();
    clearInterval(t);
    if (!res.ok) throw new Error(data.detail);
    latestClips = data.clips || [];
    renderClips(latestClips);
    setDone("Clips Generated", `Found ${latestClips.length} clips.`, 100);
    showToast(`Success! ${latestClips.length} clips created.`, "success");
  } catch(e) {
    clearInterval(t);
    els.clipsHint.innerHTML = `<div class="text-4xl">‚ùå</div><p>${e.message}</p>`;
    setDone("Error", e.message, 0, true); showToast(e.message, "error");
  }
}

function renderClips(clips) {
  els.clipsHint.classList.add("hidden");
  els.clipsBox.innerHTML = "";
  clips.forEach((c, idx) => {
    const card = document.createElement("div");
    card.className = "glass rounded-2xl p-4 border border-white/5 flex flex-col gap-3 group hover:border-cyan-500/30 transition-colors";
    const vidUrl = `${c.url}?t=${Date.now()}`;
    card.innerHTML = `
      <div class="flex justify-between items-start">
        <div><div class="text-xs font-bold text-cyan-400 mb-1">CLIP #${idx+1}</div><div class="text-white font-bold leading-tight text-lg">${c.hook || "No Hook"}</div></div>
        <div class="bg-white/10 px-2 py-1 rounded text-[10px] font-mono">Score: ${Number(c.score||0).toFixed(1)}</div>
      </div>
      <div class="relative bg-black rounded-lg overflow-hidden aspect-[9/16] shadow-2xl"><video controls preload="metadata" class="w-full h-full object-contain" src="${vidUrl}"></video></div>
      <div class="grid grid-cols-2 gap-2 text-[10px] text-white/40 font-mono bg-black/20 p-2 rounded-lg"><div>Start: ${Number(c.start).toFixed(2)}s</div><div>End: ${Number(c.end).toFixed(2)}s</div></div>
      <div class="mt-auto grid grid-cols-2 gap-3"><button class="btn btn-cyan text-xs w-full py-2" data-action="edit">‚ö° EDIT & RENDER</button><a href="${c.url}" download target="_blank" class="btn btn-ghost text-xs w-full py-2">üíæ RAW</a></div>
    `;
    const vidEl = card.querySelector("video");
    card.querySelector("[data-action='edit']").addEventListener("click", () => {
      activeClip = { ...c, _idx: idx, _videoEl: vidEl };
      openTimelineEditor();
    });
    els.clipsBox.appendChild(card);
  });
}

async function openTimelineEditor() {
  if (!activeClip) return;
  els.modal.backdrop.style.display = "flex";
  els.modal.title.textContent = `Clip #${activeClip._idx+1}`;
  els.modal.hook.value = activeClip.hook || "";
  els.modal.box.innerHTML = `<div class="flex h-full items-center justify-center text-white/30"><div class="ring"></div></div>`;
  try {
    const qs = new URLSearchParams({ transcript_name: uploadedFilename, clip_start_abs: activeClip.start, clip_end_abs: activeClip.end });
    const res = await fetch(`/api/subtitle/timeline/${encodeURIComponent(activeClip.file)}?${qs}`, { method:"POST" });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail);
    activeTimeline = (data.items || []).map(x => ({ start: Number(x.start), end: Number(x.end), text: x.text }));
    renderTimelineRows();
  } catch(e) { els.modal.box.innerHTML = `<div class="p-5 text-rose-500 text-center">${e.message}</div>`; }
}

function renderTimelineRows() {
  const box = els.modal.box; box.innerHTML = "";
  if (activeTimeline.length === 0) { box.innerHTML = `<div class="text-center p-10 text-white/20">Timeline empty. Add a line.</div>`; return; }
  activeTimeline.forEach((item, i) => {
    const row = document.createElement("div"); row.className = "rowItem";
    row.innerHTML = `<input type="number" step="0.1" class="inp font-mono text-center" value="${item.start.toFixed(2)}"><input type="number" step="0.1" class="inp font-mono text-center" value="${item.end.toFixed(2)}"><input type="text" class="inp font-semibold text-white" value="${item.text.replace(/"/g, '&quot;')}"><div class="flex justify-end gap-1"><button class="tinyBtn" data-act="up">‚ñ≤</button><button class="tinyBtn" data-act="down">‚ñº</button><button class="tinyBtn text-rose-400 hover:bg-rose-500/20" data-act="del">‚úï</button></div>`;
    const inputs = row.querySelectorAll("input");
    inputs[0].onchange = (e) => activeTimeline[i].start = Number(e.target.value);
    inputs[1].onchange = (e) => activeTimeline[i].end = Number(e.target.value);
    inputs[2].onchange = (e) => activeTimeline[i].text = e.target.value;
    row.querySelector("[data-act='up']").onclick = () => moveRow(i, -1);
    row.querySelector("[data-act='down']").onclick = () => moveRow(i, 1);
    row.querySelector("[data-act='del']").onclick = () => { activeTimeline.splice(i,1); renderTimelineRows(); };
    box.appendChild(row);
  });
}
function moveRow(idx, dir) { if (idx+dir < 0 || idx+dir >= activeTimeline.length) return; [activeTimeline[idx], activeTimeline[idx+dir]] = [activeTimeline[idx+dir], activeTimeline[idx]]; renderTimelineRows(); }
document.getElementById("btnCloseModal").onclick = () => els.modal.backdrop.style.display = "none";
document.getElementById("btnAddRow").onclick = () => { const last = activeTimeline[activeTimeline.length-1]; const start = last ? last.end + 0.1 : 0; activeTimeline.push({ start: start, end: start+1.0, text: "New Text" }); renderTimelineRows(); els.modal.box.scrollTop = els.modal.box.scrollHeight; };
document.getElementById("btnNormalize").onclick = () => { activeTimeline.sort((a,b) => a.start - b.start); renderTimelineRows(); showToast("Sorted timeline."); };

document.getElementById("btnRenderSubtitle").onclick = async () => {
   if(isBusy) return;
   const ratio = els.modal.ratio.value;
   const style = els.modal.style.value;
   const hook = els.modal.hook.value;
   const bgmMsg = customBgmFile ? "+ Custom BGM" : "";
   if(!confirm(`Render Final Video?\n\nRatio: ${ratio}\nStyle: ${style}\nHook: ${hook}\n${bgmMsg}\n\nQuality: 4K (CRF 18)`)) return;

   setLoading("Rendering...", "Applying Karaoke, Hook, BGM & HD Encoding...", 10);
   let p = 10; const t = setInterval(() => { if(!isBusy) clearInterval(t); p=Math.min(99, p+0.3); setProgress(p); }, 800);

   try {
     const payload = {
        transcript_name: uploadedFilename,
        clip_start_abs: activeClip.start,
        clip_end_abs: activeClip.end,
        items: activeTimeline,
        ratio: ratio,
        style: style,
        hook: hook,
        bgm: customBgmFile // Pass custom BGM file
     };
     const res = await fetch(`/api/subtitle/render/${encodeURIComponent(activeClip.file)}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
     const data = await res.json();
     clearInterval(t);
     if(!res.ok) throw new Error(data.detail);
     if(activeClip._videoEl) { activeClip._videoEl.src = data.url + "?t=" + Date.now(); activeClip._videoEl.load(); }
     setDone("Render Complete!", "Video updated.", 100);
     showToast("Render success!", "success");
     els.modal.backdrop.style.display = "none";
   } catch(e) { clearInterval(t); setDone("Error", e.message, 0, true); showToast(e.message, "error"); }
};

document.getElementById("themeSelect").onchange = (e) => { document.body.setAttribute("data-theme", e.target.value); };
document.onkeydown = (e) => { if(e.target.tagName === "INPUT") return; if(e.key.toLowerCase() === "u") uploadVideo(); if(e.key.toLowerCase() === "t") runTranscribe(); };
</script>
</body>
</html>